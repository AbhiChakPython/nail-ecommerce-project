{% extends "base.html" %}
{% load static %}

{% block content %}

{% if messages %}
<div class="mb-4">
    {% for message in messages %}
    <div class="px-4 py-2 rounded text-white {{ message.tags|default:'bg-blue-600' }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}


<div class="container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">
            Shop All Products
            {% if user.is_superuser %}
            <span class="ml-2 inline-block bg-yellow-400 text-black text-xs font-semibold px-2 py-1 rounded">
            Admin Mode
        </span>
            {% endif %}
        </h1>

        {% if user.is_superuser %}
        <p class="text-sm text-gray-600 mt-2">
            You have permission to manage products directly from this page.
        </p>
        {% endif %}
    </div>

    <!-- üîç Centered Search + Category Filter -->
    <form method="get" class="mb-10 flex flex-col md:flex-row justify-center items-center gap-4 max-w-4xl mx-auto">
        <!-- Search Input -->
        <div class="flex w-full md:w-auto items-center border border-pink-300 rounded-lg overflow-hidden shadow-sm">
            <input type="text" name="q"
                   placeholder="Search products..."
                   value="{{ q }}"
                   class="w-full px-4 py-2 text-gray-700 focus:outline-none">
            <button type="submit"
                    class="bg-pink-500 text-white px-4 py-2 hover:bg-pink-600 transition">
                Search
            </button>
        </div>

        <!-- Category Dropdown -->
        <select name="category"
                class="w-full md:w-1/3 px-4 py-2 border rounded-md shadow-sm text-gray-700">
            <option value="">All Categories</option>
            {% for category in categories %}
            <option value="{{ category.slug }}" {% if category.slug == selected_category %}selected{% endif %}>
                {{ category.name }}
            </option>
            {% endfor %}
        </select>

        <!-- Filter Button -->
        <button type="submit"
                class="px-4 py-2 bg-black text-white rounded-md hover:bg-gray-800">
            Filter
        </button>

        <div class="ml-5">
            <a href="{% url 'orders:cart_detail' %}"
               class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 transition inline-block">
                üõí View Cart
            </a>
        </div>
    </form>

    {% if user.is_superuser %}
    <div class="mb-4">
        <a href="{% url 'products:product_create' %}"
           title="Add New Product"
           class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
            ‚ûï Add Product
        </a>
    </div>
    {% endif %}

    {% if products %}
    <!-- üõç Product Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for product in products %}
        <article class="border rounded-xl shadow-sm hover:shadow-md transition overflow-hidden">
            <a href="{% url 'products:product_detail' slug=product.slug %}">
                {% if product.thumbnail %}
                <img src="{{ product.thumbnail.url }}" alt="{{ product.name }}" class="w-full h-48 object-cover"/>
                {% else %}
                <img src="{% static 'images/no-image.png' %}" alt="No Image" class="w-full h-48 object-cover"/>
                {% endif %}
            </a>
            <div class="p-4">
                <h2 class="text-lg font-semibold truncate">
                    <a href="{% url 'products:product_detail' slug=product.slug %}">{{ product.name }}</a>
                </h2>

                {% with discounted=product.discounted_price %}
                {% if discounted < product.variants.first.price %}
                <p class="text-sm text-red-600 font-bold">
                    ‚Çπ{{ discounted }} <span class="line-through text-gray-400 text-xs">‚Çπ{{ product.variants.first.price }}</span>
                </p>
                {% else %}
                <p class="text-sm text-gray-800 font-semibold">
                    ‚Çπ{{ product.variants.first.price }}
                </p>
                {% endif %}
                {% endwith %}

                <div class="mt-3 flex gap-2">
                    <a href="{% url 'products:product_detail' slug=product.slug %}"
                       class="px-3 py-1 bg-pink-600 text-white text-sm rounded hover:bg-pink-700">
                        View Details
                    </a>
                </div>

                {% if user.is_superuser %}
                <div class="mt-2 flex space-x-2">
                    <a href="{% url 'products:product_update' product.slug %}" class="text-blue-600 hover:underline">‚úèÔ∏è
                        Edit</a>
                    <form action="{% url 'products:product_delete' product.slug %}" method="post"
                          onsubmit="return confirm('Are you sure?');">
                        {% csrf_token %}
                        <button type="submit" class="text-red-600 hover:underline">üóëÔ∏è Delete</button>
                    </form>
                </div>
                {% endif %}

                {% if request.user.is_superuser %}
                <a href="{% url 'products:manage_variants' product.slug %}"
                   class="text-sm text-blue-600 hover:underline ml-2">
                    Manage Variants
                </a>
                {% endif %}
            </div>
        </article>
        {% endfor %}


    </div>

    {% else %}
    <p class="text-gray-500 mt-6">No products found.</p>
    {% endif %}

    <!-- üî¢ Order List Pagination -->
    <div class="mt-8 flex justify-center">
        <nav class="inline-flex rounded-md shadow-sm">
            {% if page_obj.has_previous %}
            <a href="?q={{ q }}&category={{ selected_category }}&page={{ page_obj.previous_page_number }}"
               class="px-3 py-1 border border-gray-300 rounded-l hover:bg-pink-200">
                Previous
            </a>
            {% else %}
            <span class="px-3 py-1 border border-gray-300 rounded-l text-gray-400 cursor-not-allowed">
                Previous
            </span>
            {% endif %}

            <span class="px-4 py-1 border-t border-b border-gray-300 bg-white font-semibold">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>

            {% if page_obj.has_next %}
            <a href="?q={{ q }}&category={{ selected_category }}&page={{ page_obj.next_page_number }}"
               class="px-3 py-1 border border-gray-300 rounded-r hover:bg-gray-200">
                Next
            </a>
            {% else %}
            <span class="px-3 py-1 border border-gray-300 rounded-r text-gray-400 cursor-not-allowed">
                Next
            </span>
            {% endif %}
        </nav>
    </div>
</div>
{% endblock %}
