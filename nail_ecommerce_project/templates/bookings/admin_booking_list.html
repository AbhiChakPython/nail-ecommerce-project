{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto py-8 px-4">
  <h2 class="text-2xl font-bold mb-6">Manage Bookings</h2>

  <!-- ✅ Filter & Search -->
  <form method="get" class="mb-4 flex flex-wrap items-center gap-4">
    <label class="text-sm font-medium">Filter by Status:</label>
    <select name="status" onchange="this.form.submit()" class="border px-2 py-1 rounded">
      <option value="">All</option>
      {% for code, label in status_choices %}
        <option value="{{ code }}" {% if current_filter == code %}selected{% endif %}>{{ label }}</option>
      {% endfor %}
    </select>

    <input type="text" name="q" value="{{ search_query }}"
           placeholder="Search by service or customer"
           class="border px-2 py-1 rounded" />
    <button type="submit" class="bg-pink-600 text-white px-3 py-1 rounded hover:bg-pink-700">Search</button>
  </form>

  <!-- ✅ Booking Table -->
  <table class="min-w-full bg-white rounded shadow text-sm">
    <thead class="bg-pink-100">
      <tr>
        <th class="px-4 py-2">ID</th>
        <th class="px-4 py-2">Customer</th>
        <th class="px-4 py-2">Service</th>
        <th class="px-4 py-2">Date & Time</th>
        <th class="px-4 py-2">Status</th>
        <th class="px-4 py-2">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for booking in bookings %}
      <tr class="border-t">
        <td class="px-4 py-2">#{{ booking.id }}</td>
        <td class="px-4 py-2">{{ booking.customer.full_name }}</td>
        <td class="px-4 py-2">{{ booking.service.title }}</td>
        <td class="px-4 py-2">{{ booking.date }} {{ booking.time_slot }}</td>

        <!-- ✅ Colored status badge -->
        <td class="px-4 py-2">
          {% if booking.status == 'COMPLETED_SERVICE' %}
            <span class="px-2 py-1 rounded bg-green-100 text-green-700 font-semibold text-xs">
              {{ booking.get_status_display }}
            </span>
          {% elif booking.status == 'CANCELLED_SERVICE' %}
            <span class="px-2 py-1 rounded bg-red-100 text-red-700 font-semibold text-xs">
              {{ booking.get_status_display }}
            </span>
          {% else %}
            <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-700 font-semibold text-xs">
              {{ booking.get_status_display }}
            </span>
          {% endif %}
        </td>

        <!-- ✅ Actions: Disabled for terminal states -->
        <td class="px-4 py-2">
          <form method="post"
                action="{% url 'bookings_admin:update_booking_status' booking.id %}"
                class="inline"
                id="form-{{ booking.id }}">
              {% csrf_token %}
              <select name="status"
                      id="status-select-{{ booking.id }}"
                      class="border rounded px-2 py-1 text-sm"
                      data-current-status="{{ booking.status }}"
                      onchange="toggleUpdateButton('{{ booking.id }}')"
                      {% if booking.status in terminal_statuses %}disabled{% endif %}
                  {% for code, label in status_choices %}
                      <option value="{{ code }}" {% if booking.status == code %}selected{% endif %}>{{ label }}</option>
                  {% endfor %}
              </select>
              <button type="submit"
                      id="update-btn-{{ booking.id }}"
                      class="ml-2 bg-pink-600 text-white px-2 py-1 rounded hover:bg-pink-700 disabled:opacity-50 disabled:cursor-not-allowed"
                      {% if booking.status in terminal_statuses %}disabled{% endif %}
                  Update
              </button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" class="px-4 py-4 text-center text-gray-500">No bookings found.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ✅ Pagination -->
  <div class="mt-6">
    {% if page_obj.has_other_pages %}
      <nav class="inline-flex space-x-1">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}&status={{ current_filter }}&q={{ search_query }}"
             class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded-l">Prev</a>
        {% else %}
          <span class="px-3 py-1 bg-gray-100 text-gray-400 text-sm rounded-l cursor-not-allowed">Prev</span>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
          {% if page_obj.number == num %}
            <span class="px-3 py-1 bg-pink-600 text-white text-sm font-semibold">{{ num }}</span>
          {% else %}
            <a href="?page={{ num }}&status={{ current_filter }}&q={{ search_query }}"
               class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm">{{ num }}</a>
          {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}&status={{ current_filter }}&q={{ search_query }}"
             class="px-3 py-1 bg-gray-200 hover:bg-gray-300 text-sm rounded-r">Next</a>
        {% else %}
          <span class="px-3 py-1 bg-gray-100 text-gray-400 text-sm rounded-r cursor-not-allowed">Next</span>
        {% endif %}
      </nav>
    {% endif %}
  </div>
</div>
<script>
  function toggleUpdateButton(bookingId) {
    const select = document.getElementById(`status-select-${bookingId}`);
    const button = document.getElementById(`update-btn-${bookingId}`);
    const currentStatus = select.getAttribute("data-current-status");
    const selectedStatus = select.value;

    if (selectedStatus === currentStatus) {
      button.disabled = true;
    } else {
      button.disabled = false;
    }
  }

  // Optional: On page load, initialize all buttons to be disabled
  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("select[id^='status-select-']").forEach((select) => {
      const bookingId = select.id.split('-')[2];
      toggleUpdateButton(bookingId);
    });
  });

  // Auto-dismiss alerts
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(el => el.style.display = 'none');
  }, 3000);
</script>
{% endblock %}
