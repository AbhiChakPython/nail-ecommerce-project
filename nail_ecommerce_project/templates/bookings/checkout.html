{% extends "base.html" %}
{% block content %}
<div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-md mt-10">
    <h2 class="text-2xl font-bold mb-4">Complete Your Booking</h2>

    {% if not booking.razorpay_payment_id %}
      <p class="text-sm text-yellow-700 bg-yellow-100 border border-yellow-300 rounded px-4 py-2 mb-4">
        ‚ö†Ô∏è Payment is still <strong>Pending</strong>. Please complete it to confirm your booking.
      </p>
    {% endif %}

    <!-- Booking Summary -->
    <div class="mb-6">
        <p class="text-gray-700"><strong>Service:</strong> {{ booking.service.title }}</p>
        <p class="text-gray-700"><strong>Scheduled On:</strong> {{ booking.date }} at {{ booking.time_slot }}</p>
        <p class="text-gray-700"><strong>Booking For:</strong> {{ booking.number_of_customers }} customer(s)</p>

        {% if booking.number_of_customers >= 2 %}
        <p class="text-green-700 font-semibold mt-2">Group Discount (5%) Applied</p>
        {% endif %}

        {% if booking.is_home_service %}
        <p class="text-indigo-700 font-semibold mt-2">üè† Home Visit Included (+‚Çπ250)</p>
        {% endif %}

        <p class="mt-3 text-lg font-bold text-pink-700">
            Final Price: ‚Çπ{{ booking.get_final_price|floatformat:"2" }}
        </p>
    </div>

    {% if not booking.razorpay_payment_id %}
    <!-- ‚ùó Payment Not Done Yet -->
    <form id="razorpay-form" method="POST" action="{% url 'bookings:payment_callback' booking.id %}">
        {% csrf_token %}
        <input type="hidden" name="razorpay_payment_id" id="rzp_payment_id">
        <input type="hidden" name="razorpay_signature" id="rzp_signature">
        <input type="hidden" name="razorpay_order_id" id="rzp_order_id">
    </form>

    <!-- Show Retry/Cancel Option -->
    <div class="mt-6 flex justify-between">
        <form method="post" action="{% url 'bookings:retry_payment' booking.id %}">
            {% csrf_token %}
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">
                üîÅ Retry Payment
            </button>
        </form>

        <form method="post" action="{% url 'bookings:cancel_booking' booking.id %}"
              onsubmit="return confirm('Are you sure you want to cancel this booking?');">
            {% csrf_token %}
            <button type="submit" class="text-red-600 border border-red-400 px-4 py-2 rounded hover:bg-red-50">
                ‚ùå Cancel Booking
            </button>
        </form>
    </div>

    <!-- Razorpay Script (auto-open) -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        const options = {
          key: "{{ razorpay_key_id }}",
          amount: {{ booking.get_final_price|floatformat:'0' }} * 100,
          currency: "INR",
          name: "Rupa's Nails Xtension Hub",
          order_id: "{{ booking.razorpay_order_id }}",
          prefill: {
            name: "{{ request.user.full_name|default:''|escapejs }}",
            email: "{{ request.user.email|default:''|escapejs }}",
            contact: "{{ request.user.phone_number|default:''|escapejs }}"
          },
          handler: function (response) {
            const form = document.getElementById('razorpay-form');
            document.getElementById('rzp_payment_id').value = response.razorpay_payment_id;
            document.getElementById('rzp_signature').value = response.razorpay_signature;
            document.getElementById('rzp_order_id').value = response.razorpay_order_id;
            form.submit();
          }
        };
        const rzp = new Razorpay(options);
        rzp.open();
    </script>

    {% else %}
    <!-- ‚úÖ Payment Already Done -->
    <div class="p-4 bg-green-100 border border-green-400 text-green-800 rounded mt-6">
        ‚úÖ <strong>Payment Successful!</strong><br>
        Your booking has been confirmed and is being processed.
    </div>
    {% endif %}
</div>
{% endblock %}
